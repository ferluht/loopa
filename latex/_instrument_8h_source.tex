\hypertarget{_instrument_8h_source}{}\doxysection{Instrument.\+h}
\label{_instrument_8h_source}\index{core/Instrument.h@{core/Instrument.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//}}
\DoxyCodeLine{2 \textcolor{comment}{// Created by ferluht on 08/07/2022.}}
\DoxyCodeLine{3 \textcolor{comment}{//}}
\DoxyCodeLine{4 }
\DoxyCodeLine{5 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{6 }
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include <mutex>}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <cmath>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <set>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include "{}AMG.h"{}}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{keyword}{class }\mbox{\hyperlink{class_voice_state}{VoiceState}} \{}
\DoxyCodeLine{15 }
\DoxyCodeLine{16     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} key;}
\DoxyCodeLine{17     \textcolor{keywordtype}{bool} active;}
\DoxyCodeLine{18 }
\DoxyCodeLine{19 \textcolor{keyword}{public}:}
\DoxyCodeLine{20 }
\DoxyCodeLine{21     \mbox{\hyperlink{class_voice_state}{VoiceState}}() \{}
\DoxyCodeLine{22         active = \textcolor{keyword}{false};}
\DoxyCodeLine{23     \};}
\DoxyCodeLine{24 }
\DoxyCodeLine{25     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} enable() \{ active = \textcolor{keyword}{true}; \}}
\DoxyCodeLine{26     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} disable() \{ active = \textcolor{keyword}{false}; \}}
\DoxyCodeLine{27     \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} isActive() \{ \textcolor{keywordflow}{return} active; \}}
\DoxyCodeLine{28 }
\DoxyCodeLine{29     \textcolor{keyword}{template} <\textcolor{keyword}{class} VoiceState> \textcolor{keyword}{friend} \textcolor{keyword}{class }\mbox{\hyperlink{class_poly_instrument}{PolyInstrument}};}
\DoxyCodeLine{30 \};}
\DoxyCodeLine{31 }
\DoxyCodeLine{32 \textcolor{keyword}{class }\mbox{\hyperlink{class_instrument}{Instrument}} : \textcolor{keyword}{public} \mbox{\hyperlink{class_a_m_g}{AMG}} \{}
\DoxyCodeLine{33 \textcolor{keyword}{public}:}
\DoxyCodeLine{34     \mbox{\hyperlink{class_instrument}{Instrument}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} * name) : \mbox{\hyperlink{class_a_m_g}{AMG}}(name) \{}
\DoxyCodeLine{35 }
\DoxyCodeLine{36     \}}
\DoxyCodeLine{37 \};}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{template} <\textcolor{keyword}{class} TVoiceState>}
\DoxyCodeLine{40 \textcolor{keyword}{class }\mbox{\hyperlink{class_poly_instrument}{PolyInstrument}} : \textcolor{keyword}{public} \mbox{\hyperlink{class_instrument}{Instrument}} \{}
\DoxyCodeLine{41 }
\DoxyCodeLine{42     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} num\_voices = 4;}
\DoxyCodeLine{43     std::list<TVoiceState *> voices;}
\DoxyCodeLine{44 }
\DoxyCodeLine{45     std::mutex keyPressedLock;}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \textcolor{comment}{//    bool damper\_pedal;}}
\DoxyCodeLine{48 \textcolor{comment}{//    bool portamento;}}
\DoxyCodeLine{49 \textcolor{comment}{//    bool sostenuto;}}
\DoxyCodeLine{50 \textcolor{comment}{//    bool soft\_pedal;}}
\DoxyCodeLine{51 \textcolor{comment}{//    bool chorus;}}
\DoxyCodeLine{52 \textcolor{comment}{//    bool celeste;}}
\DoxyCodeLine{53 \textcolor{comment}{//    bool phaser;}}
\DoxyCodeLine{54 }
\DoxyCodeLine{55     \textcolor{keywordtype}{int} \_prev\_active\_voices = 0;}
\DoxyCodeLine{56 }
\DoxyCodeLine{57 \textcolor{keyword}{public}:}
\DoxyCodeLine{58 }
\DoxyCodeLine{59     \textcolor{keywordtype}{float} base\_note = 69.0;}
\DoxyCodeLine{60     \textcolor{keywordtype}{float} power\_base = 2.0;}
\DoxyCodeLine{61     \textcolor{keywordtype}{float} semitones = 12.0;}
\DoxyCodeLine{62     \textcolor{keywordtype}{float} instrument\_volume = 1;}
\DoxyCodeLine{63     \textcolor{keywordtype}{double} base\_frequency = 440.0;}
\DoxyCodeLine{64 }
\DoxyCodeLine{65     \textcolor{keywordtype}{float} pitch = 0;}
\DoxyCodeLine{66     \textcolor{keywordtype}{float} pitch\_distance = 12.0;}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \mbox{\hyperlink{class_poly_instrument}{PolyInstrument}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} * name) : \mbox{\hyperlink{class_instrument}{Instrument}}(name)\{}
\DoxyCodeLine{69         pitch = 0;}
\DoxyCodeLine{70         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < num\_voices; i++) voices.push\_back(\textcolor{keyword}{new} TVoiceState());}
\DoxyCodeLine{71 }
\DoxyCodeLine{72         \mbox{\hyperlink{class_m_af2037e5190cff1802d694edd919c9a90}{addMIDIHandler}}(\{NOTEON\_HEADER, NOTEOFF\_HEADER\}, [\textcolor{keyword}{this}](\mbox{\hyperlink{struct_m_data}{MData}} \&cmd) -\/> MIDISTATUS \{}
\DoxyCodeLine{73             keyPressed(cmd);}
\DoxyCodeLine{74             \textcolor{keywordflow}{return} MIDISTATUS::DONE;}
\DoxyCodeLine{75         \});}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \mbox{\hyperlink{class_m_af2037e5190cff1802d694edd919c9a90}{addMIDIHandler}}(PITCHWHEEL\_HEADER, [\textcolor{keyword}{this}](\mbox{\hyperlink{struct_m_data}{MData}} \&cmd) -\/> MIDISTATUS \{}
\DoxyCodeLine{78             pitch = (cmd.data1 + cmd.data2*128.0f) / (\textcolor{keywordtype}{float})0xFFFF * pitch\_distance;}
\DoxyCodeLine{79             \textcolor{keywordflow}{return} MIDISTATUS::DONE;}
\DoxyCodeLine{80         \});}
\DoxyCodeLine{81     \}}
\DoxyCodeLine{82 }
\DoxyCodeLine{83     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_poly_instrument_a56b9765c2366de8c6b2815a208285993}{process}}(\textcolor{keywordtype}{float} *outputBuffer, \textcolor{keywordtype}{float} * inputBuffer,}
\DoxyCodeLine{84                  \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} nBufferFrames, \textcolor{keywordtype}{double} streamTime) \textcolor{keyword}{override};}
\DoxyCodeLine{85 }
\DoxyCodeLine{86     \textcolor{keywordtype}{void} keyPressed(\mbox{\hyperlink{struct_m_data}{MData}}\& md);}
\DoxyCodeLine{87 }
\DoxyCodeLine{88     \textcolor{keyword}{inline} \textcolor{keywordtype}{float} getFrequency(\textcolor{keywordtype}{float} note)}
\DoxyCodeLine{89     \{}
\DoxyCodeLine{90         \textcolor{keywordflow}{return} base\_frequency*(powf(power\_base, (note -\/ base\_note + pitch)/semitones));}
\DoxyCodeLine{91     \}}
\DoxyCodeLine{92 }
\DoxyCodeLine{93     \textcolor{keyword}{inline} \textcolor{keywordtype}{float} getPhaseIncrement(\textcolor{keywordtype}{float} note)}
\DoxyCodeLine{94     \{}
\DoxyCodeLine{95         \textcolor{keywordflow}{return} 2*M\_PI*getFrequency(note) / SAMPLERATE;}
\DoxyCodeLine{96     \}}
\DoxyCodeLine{97 }
\DoxyCodeLine{98     \textcolor{keywordtype}{void} set\_voices(uint8\_t nvoices) \{}
\DoxyCodeLine{99         \textcolor{keywordflow}{while} (voices.size() > nvoices) voices.pop\_front();}
\DoxyCodeLine{100         \textcolor{keywordflow}{while} (voices.size() < nvoices) voices.push\_back(\textcolor{keyword}{new} TVoiceState());}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} updateVoice(TVoiceState * voiceState, \mbox{\hyperlink{struct_m_data}{MData}} cmd) \{\};}
\DoxyCodeLine{104 }
\DoxyCodeLine{105     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} processVoice(TVoiceState * voiceState, \textcolor{keywordtype}{float} *outputBuffer, \textcolor{keywordtype}{float} * inputBuffer,}
\DoxyCodeLine{106                               \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} nBufferFrames, \textcolor{keywordtype}{double} streamTime, uint8\_t nvoices) \{\}}
\DoxyCodeLine{107 \};}
\DoxyCodeLine{108 }
\DoxyCodeLine{109 \textcolor{keyword}{template} <\textcolor{keyword}{class} TVoiceState>}
\DoxyCodeLine{110 \textcolor{keywordtype}{void} \mbox{\hyperlink{class_poly_instrument}{PolyInstrument<TVoiceState>::keyPressed}}(\mbox{\hyperlink{struct_m_data}{MData}} \&md) \{}
\DoxyCodeLine{111     keyPressedLock.lock();}
\DoxyCodeLine{112 }
\DoxyCodeLine{113     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = voices.begin(); it != voices.end(); it++ )}
\DoxyCodeLine{114     \{}
\DoxyCodeLine{115         \textcolor{keywordflow}{if} ((*it)-\/>key == md.data1)\{}
\DoxyCodeLine{116             TVoiceState * state = (*it);}
\DoxyCodeLine{117             voices.erase(it);}
\DoxyCodeLine{118             updateVoice(state, md);}
\DoxyCodeLine{119             state-\/>key = md.data1;}
\DoxyCodeLine{120             voices.push\_back(state);}
\DoxyCodeLine{121             keyPressedLock.unlock();}
\DoxyCodeLine{122             \textcolor{keywordflow}{return};}
\DoxyCodeLine{123         \}}
\DoxyCodeLine{124     \}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = voices.begin(); it != voices.end(); it++ )}
\DoxyCodeLine{127     \{}
\DoxyCodeLine{128         \textcolor{keywordflow}{if} (!(*it)-\/>isActive())\{}
\DoxyCodeLine{129             TVoiceState * state = (*it);}
\DoxyCodeLine{130             voices.erase(it);}
\DoxyCodeLine{131             updateVoice(state, md);}
\DoxyCodeLine{132             state-\/>key = md.data1;}
\DoxyCodeLine{133             voices.push\_back(state);}
\DoxyCodeLine{134             keyPressedLock.unlock();}
\DoxyCodeLine{135             \textcolor{keywordflow}{return};}
\DoxyCodeLine{136         \}}
\DoxyCodeLine{137     \}}
\DoxyCodeLine{138 }
\DoxyCodeLine{139     TVoiceState * state = *voices.begin();}
\DoxyCodeLine{140     updateVoice(state, md);}
\DoxyCodeLine{141     state-\/>key = md.data1;}
\DoxyCodeLine{142     voices.pop\_front();}
\DoxyCodeLine{143     voices.push\_back(state);}
\DoxyCodeLine{144 }
\DoxyCodeLine{145     keyPressedLock.unlock();}
\DoxyCodeLine{146 \}}
\DoxyCodeLine{147 }
\DoxyCodeLine{148 \textcolor{keyword}{template} <\textcolor{keyword}{class} TVoiceState>}
\DoxyCodeLine{149 \textcolor{keywordtype}{void} \mbox{\hyperlink{class_poly_instrument_a56b9765c2366de8c6b2815a208285993}{PolyInstrument<TVoiceState>::process}}(\textcolor{keywordtype}{float} *outputBuffer, \textcolor{keywordtype}{float} * inputBuffer,}
\DoxyCodeLine{150                                 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} nBufferFrames, \textcolor{keywordtype}{double} streamTime)}
\DoxyCodeLine{151 \{}
\DoxyCodeLine{152     keyPressedLock.lock();}
\DoxyCodeLine{153 }
\DoxyCodeLine{154     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = voices.begin(); it != voices.end(); it++ )\{}
\DoxyCodeLine{155         \textcolor{keywordflow}{if} (PERF\_TESTING || (*it)-\/>isActive())}
\DoxyCodeLine{156             processVoice(*it, outputBuffer, inputBuffer, nBufferFrames, streamTime, num\_voices);}
\DoxyCodeLine{157     \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159     keyPressedLock.unlock();}
\DoxyCodeLine{160 \}}

\end{DoxyCode}
